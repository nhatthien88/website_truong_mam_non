{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3><i class="bi bi-graph-up me-2"></i>Thống kê - Báo cáo</h3>
  <a href="{{ url_for('admin.export_reports_pdf') }}" class="btn btn-danger">
    <i class="bi bi-file-earmark-pdf me-2"></i>Xuất PDF
  </a>
</div>

<div class="row mb-4">
  <div class="col-md-4 mb-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1">Tổng học sinh</h6>
            <h3 class="mb-0">{{ total_students }}</h3>
          </div>
          <div class="bg-primary bg-opacity-10 p-3 rounded">
            <i class="bi bi-people-fill fs-2 text-primary"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1">Tổng lớp học</h6>
            <h3 class="mb-0">{{ total_classes }}</h3>
          </div>
          <div class="bg-success bg-opacity-10 p-3 rounded">
            <i class="bi bi-door-open-fill fs-2 text-success"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1">Doanh thu tháng này</h6>
            <h3 class="mb-0">{{ "{:,}".format(current_month_revenue) }}</h3>
            <small class="text-muted">VND</small>
          </div>
          <div class="bg-warning bg-opacity-10 p-3 rounded">
            <i class="bi bi-currency-dollar fs-2 text-warning"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="row mb-4">
  <div class="col-lg-4 mb-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0"><i class="bi bi-pie-chart-fill me-2"></i>Tỷ lệ nam/nữ</h5>
      </div>
      <div class="card-body d-flex align-items-center justify-content-center">
        <div style="max-width: 280px; width: 100%;">
          <canvas id="genderChart"></canvas>
        </div>
      </div>
      <div class="card-footer bg-white border-0">
        <div class="d-flex justify-content-around text-center">
          <div>
            <div class="text-muted small">Nam</div>
            <div class="fw-bold text-primary">{{ gender['M'] }}</div>
          </div>
          <div>
            <div class="text-muted small">Nữ</div>
            <div class="fw-bold" style="color: #ff6384;">{{ gender['F'] }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="col-lg-8 mb-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0"><i class="bi bi-bar-chart-fill me-2"></i>Sĩ số từng lớp</h5>
      </div>
      <div class="card-body">
        <canvas id="classSizeChart"></canvas>
      </div>
    </div>
  </div>
</div>


<div class="row mb-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Doanh thu theo tháng (Hóa đơn đã thanh toán)</h5>
      </div>
      <div class="card-body">
        <canvas id="revenueChart" style="max-height: 300px;"></canvas>
      </div>
    </div>
  </div>
</div>


<div class="row">

  <div class="col-lg-6 mb-4">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0"><i class="bi bi-table me-2"></i>Chi tiết sĩ số lớp</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Lớp</th>
                <th class="text-end">Sĩ số</th>
              </tr>
            </thead>
            <tbody>
              {% for cid, name, count in class_sizes %}
              <tr>
                <td><i class="bi bi-mortarboard me-2 text-primary"></i>{{ name }}</td>
                <td class="text-end"><span class="badge bg-primary">{{ count }}</span></td>
              </tr>
              {% endfor %}
              {% if not class_sizes %}
              <tr>
                <td colspan="2" class="text-center text-muted py-4">
                  <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                  Chưa có dữ liệu
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


  <div class="col-lg-6 mb-4">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0"><i class="bi bi-table me-2"></i>Chi tiết doanh thu</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Tháng</th>
                <th class="text-end">Tổng thu (VND)</th>
              </tr>
            </thead>
            <tbody>
              {% for r in revenue %}
              <tr>
                <td><i class="bi bi-calendar-month me-2 text-success"></i>{{ r.month }}</td>
                <td class="text-end fw-bold text-success">{{ "{:,}".format(r.total) }}</td>
              </tr>
              {% endfor %}
              {% if not revenue %}
              <tr>
                <td colspan="2" class="text-center text-muted py-4">
                  <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                  Chưa có dữ liệu
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>


<div id="chartData" style="display:none;" data-gender-male="{{ gender['M'] }}" data-gender-female="{{ gender['F'] }}"
  data-class-labels='{{ class_sizes|map(attribute="1")|list|tojson }}'
  data-class-data='{{ class_sizes|map(attribute="2")|list|tojson }}'
  data-revenue-labels='{{ (revenue|reverse|list)|map(attribute="month")|list|tojson }}'
  data-revenue-data='{{ (revenue|reverse|list)|map(attribute="total")|list|tojson }}'>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>

  const chartDataEl = document.getElementById('chartData');
  const genderMale = parseInt(chartDataEl.dataset.genderMale);
  const genderFemale = parseInt(chartDataEl.dataset.genderFemale);
  const classLabels = JSON.parse(chartDataEl.dataset.classLabels);
  const classData = JSON.parse(chartDataEl.dataset.classData);
  const revenueLabels = JSON.parse(chartDataEl.dataset.revenueLabels);
  const revenueData = JSON.parse(chartDataEl.dataset.revenueData);


  const genderCtx = document.getElementById('genderChart');
  new Chart(genderCtx, {
    type: 'doughnut',
    data: {
      labels: ['Nam', 'Nữ'],
      datasets: [{
        data: [genderMale, genderFemale],
        backgroundColor: ['#0d6efd', '#ff6384'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            font: { size: 12 }
          }
        }
      }
    }
  });


  const classSizeCtx = document.getElementById('classSizeChart');
  new Chart(classSizeCtx, {
    type: 'bar',
    data: {
      labels: classLabels,
      datasets: [{
        label: 'Sĩ số',
        data: classData,
        backgroundColor: '#0d6efd',
        borderRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });


  const revenueCtx = document.getElementById('revenueChart');
  new Chart(revenueCtx, {
    type: 'line',
    data: {
      labels: revenueLabels,
      datasets: [{
        label: 'Doanh thu (VND)',
        data: revenueData,
        borderColor: '#198754',
        backgroundColor: 'rgba(25, 135, 84, 0.1)',
        fill: true,
        tension: 0.4,
        borderWidth: 2,
        pointRadius: 4,
        pointBackgroundColor: '#198754'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function (value) {
              return value.toLocaleString('vi-VN');
            }
          }
        }
      }
    }
  });
</script>
{% endblock %}